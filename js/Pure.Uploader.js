/**
 * HTML5 Pure Uploader 2.0
 * http://www.tqera.com/
 *
 * Copyright 2014, Lyzerk
 *
 * Date: 23-04-2014
 */
function printLog(n){console.log("------Log Report------");console.log(new Date);console.log(n);console.log("------##########------")}function printError(n){typeof n=="object"?(n.message&&(console.log("------Error Message------"),console.log("\nMessage: "+n.message)),n.stack&&console.log(n.stack),console.log("------#############------")):console.log("printError :: argument is not an object")}function contains(n,t){for(var i in t)if(n.match(t[i]))return!0;return!1}function getFileExtension(n){var t=n.split(".");return t.length===1||t[0]===""&&t.length===2?"":t.pop().toLowerCase()}function endsWith(n,t){return n.indexOf(t,n.length-t.length)!==-1}function humanFileSize(n,t){var i=t?1e3:1024,u,r;if(n<i)return n+" B";u=t?["KB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];r=-1;do n/=i,++r;while(n>=i);return n.toFixed(1)+" "+u[r]}function extend(){var f,u,i,t,e,o,n=arguments[0]||{},r=1,h=arguments.length,s=!1;for(typeof n=="boolean"&&(s=n,n=arguments[1]||{},r=2),typeof n=="object"||jQuery.isFunction(n)||(n={}),h===r&&(n=this,--r);r<h;r++)if((f=arguments[r])!=null)for(u in f)(i=n[u],t=f[u],n!==t)&&(s&&t&&(jQuery.isPlainObject(t)||(e=jQuery.isArray(t)))?(e?(e=!1,o=i&&jQuery.isArray(i)?i:[]):o=i&&jQuery.isPlainObject(i)?i:{},n[u]=jQuery.extend(s,o,t)):t!==undefined&&(n[u]=t));return n}function tQEraUploader(n){function v(n){return n.drop?n.dropPlace?(n.dropPlace.ondragover=function(){return this.className.match(n.dragHoverClass)||(this.className+=" "+n.dragHoverClass),!1},n.dropPlace.ondragleave=function(){return this.className.match(n.dragHoverClass)&&(this.className=this.className.replace(n.dragHoverClass,"")),!1},n.dropPlace.ondrop=function(n){return this.className.match(t.dragHoverClass)&&(this.className=this.className.replace(t.dragHoverClass,"")),c(n.dataTransfer.files),!1},!0):!1:!0}function y(n){return n.imageHolder?!0:!1}function p(n){return n.file_input&&n.file_input.tagName=="INPUT"&&n.file_input.type=="file"?(n.file_input.addEventListener("change",tt,!1),!0):!1}function w(n){if(n.file_filter||n.file_filter!=" "){var t=n.file_filter.split("|");return t.length<1?!1:(h=t,!0)}return!1}function b(n){return n.image.thumb?n.image.thumb_width&&n.image.thumb_height?n.image.thumb_width>10&&n.image.thumb_height>10?!0:(t.error("Thumbnail must be higher than 10x10"),!1):!1:!0}function k(n){return parseInt(n.file_size)?!0:(t.error("File size must be integer"),!1)}function d(n){return n.form?!0:!1}function g(n){n.watermark.image&&(r.src=t.watermark.image,r.onerror=function(){printLog("Watermark image can not initialize, watermark text will be on.");n.watermark.image=""})}function nt(n){var i,r;try{i=document.createElement("div");i.id=n;i.className=t.file_class;r=document.createElement("a");r.className=t.file_closebutton_class;r.href="javascript:void(0)";r.textContent="×";r.addEventListener("click",o,!1);i.appendChild(r);i.appendChild(u);t.imageHolder.appendChild(i);t.imageHolder.appendChild(u)}catch(f){t.error("Create image problem")}}function c(n){for(var r in n)typeof n[r]=="object"&&(contains(n[r].type,h)?n[r].size<t.file_size?t.limit==0?f.push(n[r]):i.length<=t.limit?f.push(n[r]):t.error("Upload limit is "+t.limit):t.error("File size to bigger"):t.error("File doesn't support"));e()}function tt(n){c(n.target.files)}function e(){var r=f.shift(),n;if(r!=null){if(t.limit!=0&&i.length+1>t.limit)return t.error("Limit are "+t.limit),!1;n="temp_"+(new Date).getTime();nt(n);a.push(n);it(n,r)}}function it(n,u){var h=new FileReader,f=document.getElementById(n),o,c;h.onload=function(n){var l,o;if(n.preventDefault(),isCanvasText&&u.type.match("image")){var c=document.createElement("canvas"),v=c.getContext("2d"),h=document.createElement("canvas"),a=h.getContext("2d"),o=new Image;o.onload=function(){var k=1,d,g,n,y,b,w,l,p;if(d=t.image.resize_width&&t.image.resize_width!=0?t.image.resize_width:o.width,g=!t.image.keep_aspect_ratio&&t.image.resize_height&&t.image.resize_height!=0?t.image.resize_height:t.image.keep_aspect_ratio&&t.image.resize_width&&t.image.resize_width!=0?t.image.resize_width/(o.width/o.height):o.height,o.width>t.image.thumb_width?k=t.image.thumb_width/o.width:o.height>t.image.thumb_height&&(k=t.image.thumb_height/o.height),h.width=d,h.height=g,a.drawImage(o,0,0,h.width,h.height),t.watermark.watermark){if(n=document.createElement("canvas"),y=n.getContext("2d"),n.width=d,n.height=g,t.watermark.image)b=r.width,w=r.height,t.watermark.image_aspect_ratio&&(b=r.width,w=r.height/(d/g)),l=0,p=w,t.watermark.position.match("bottom")?p=n.height-w:t.watermark.position.match("top")?p=0:t.watermark.position.match("center")&&(p=(n.height-w)/2),t.watermark.position.match("left")?l=0:t.watermark.position.match("mid")?l=(n.width-b)/2:t.watermark.position.match("right")&&(l=n.width-b),y.globalAlpha=t.watermark.alpha,y.drawImage(r,l,p,b,w);else if(t.watermark.text){y.fillStyle=t.watermark.color;y.font=t.watermark.font_size+" "+t.watermark.font;y.globalAlpha=t.watermark.alpha;var tt=y.measureText(t.watermark.text),nt=t.watermark.font_size.match("px")?t.watermark.font_size.replace("px",""):t.watermark.font_size,l=0,p=nt;t.watermark.position.match("bottom")?p=n.height-nt*.3:t.watermark.position.match("top")?l=0+nt*.3:t.watermark.position.match("center")&&(p=(n.height-nt)/2);t.watermark.position.match("left")?l=0:t.watermark.position.match("mid")?l=(n.width-tt.width)/2:t.watermark.position.match("right")&&(l=n.width-tt.width);y.translate(l,p);y.fillText(t.watermark.text,0,0)}a.drawImage(n,0,0,n.width,n.height,0,0,n.width,n.height)}if(c.width=o.width*k,c.height=o.height*k,v.drawImage(h,0,0,h.width,h.height,0,0,c.width,c.height),i.push({data:h.toDataURL(u.type),name:u.name,id:f.id}),t.image.thumb){try{c.style.cursor="pointer";c.onclick=function(){var n=window.open(h.toDataURL(u.type),"_blank");n.focus()}}catch(it){t.error(1,it)}f.appendChild(c)}e();t.auto_upload&&s(null);delete h;delete a};o.src=this.result}else l=getFileExtension(u.name),l=(endsWith(t.icon.path,"/")?"":"/")+l,t.icon.icon&&(o=document.createElement("img"),o.width=t.icon.width,o.height=t.icon.height,o.src="http://"+location.host+t.icon.path+l+".png",o.onerror=function(){o.src=location.protocol+"//"+location.host+t.icon._default;o.onerror=undefined},f.appendChild(o)),i.push({data:this.result,name:u.name,id:f.id}),e(),t.auto_upload&&s(null)};o=document.createElement("p");c=humanFileSize(u.size,!0);o.textContent=u.name+" "+c;f.appendChild(o);h.readAsDataURL(u)}function o(n){var r,u;if(typeof n=="object")o(n.currentTarget.parentNode.id);else for(r in i)i[r].id==n&&(i.splice(r,1),u=document.getElementById(n),t.imageHolder.removeChild(u))}function s(n){var u,r;n&&n.preventDefault();for(u in i)r=new XMLHttpRequest,r.open("POST",t.ajax.url,!0),r.setRequestHeader("Content-type",i[u].data.split(",")[0]),r.setRequestHeader("Uploader-Name",i[u].name),r.onerror=rt,r.upload.template_id=i[u].id,r.onreadystatechange=l,r.upload.addEventListener("load",l,!1),r.upload.addEventListener("progress",ut,!1),r.send(i[u].data);return!1}function rt(n){var t,i;n.template_id&&(t=document.getElementById(n.template_id),t!=null&&(i=t.getElementsByTagName("p")[0],i.className=i.className+"file_error"))}function ut(n){if(t.progress){var i=n.totalSize*100/n.position;t.progress({percent:i,template:n.target.template_id})}}function l(n){n.target.readyState==4&&(n.target.status==200?(t.ajax.clearAfterUpload&&setTimeout(o,1500,n.target.upload.template_id),t.success&&(t.progress({percent:100,template:n.target.upload.template_id}),t.success(n))):t.error("network",n))}var r;n=extend(!1,defaultSettings,n);var h,t=n,u=document.createElement("div"),f=[],i=[],a=[];if(this.settings=t,!isHTML5()){n.html5Error(this);return}if(r=new Image,!v(t))return printLog("Drop Place can't initialize")&&!1;if(!y(t))return printLog("Image Holder can't initialize")&&!1;if(!p(t))return printLog("File Input can't initialize")&&!1;if(!w(t))return printLog("File Filter can't initialize")&&!1;if(!b(t))return printLog("Image Properties (thumb, width, height) can't initialize")&&!1;if(!k(t))return printLog("File Size can't initialize")&&!1;if(!d(t))return printLog("File Form can't initialize")&&!1;!g(t);n.dropPlace.onclick=function(){t.file_input.click()};t.form.addEventListener("submit",s,!1);u.style.clear="both"}var defaultSettings={drop:!0,dropPlace:document.getElementById("dropPlace"),dragHoverClass:"hover",imageHolder:document.getElementById("imageHolder"),file_input:document.getElementById("fileInput"),file_filter:"image|text",file_size:15e7,file_class:"file",file_closebutton_class:"close",limit:0,ajax:{url:"",clearAfterUpload:!0},form:document.getElementById("imageForm"),image:{thumb:!0,thumb_width:200,thumb_height:200,resize_width:0,resize_height:0,keep_aspect_ratio:!1},watermark:{watermark:!0,image:"",image_aspect_ratio:!1,text:"www.yourweb.com",color:"grey",alpha:1,font_size:"55px",font:"bold sans-serif",position:"mid center"},icon:{icon:!0,path:"/images/icons",_default:"/images/icons/_blank.png",width:128,height:128},auto_upload:!1,debug:!1,html5Error:function(){printLog("Not Html5 Support")},success:function(){printLog("Pictures sended.")},progress:function(n){printLog("Picture "+n)},error:function(){}},isLocalStorage=function(){try{return localStorage.setItem(mod,mod),localStorage.removeItem(mod),!0}catch(n){return!1}},isCanvas=function(){var n=document.createElement("canvas");return!!(n.getContext&&n.getContext("2d"))},isCanvasText=function(){return!!(isCanvas()&&is(document.createElement("canvas").getContext("2d").fillText,"function"))},isHTML5=function(){return isCanvasText&&isLocalStorage&&window.File&&window.FileReader&&window.FileList&&window.Blob&&window.FormData}